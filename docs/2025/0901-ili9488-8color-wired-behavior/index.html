<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

  <meta name="keywords" content="シャポログ ${blog.article_keywords}">
  <meta name="description" content="AliExpress と Amazon で 480x320px の LCD モジュールを買ったのですが、ILI9488 の 8 色モードを試そうとしたところ謎の挙動に悩まされたので記録として残しておきます。">

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@shapoco" />
  <meta property="og:url" content="https://blog.shapoco.net/2025/0901-ili9488-8color-wired-behavior/" />
  <meta property="og:title" content="ILI9488 LCDモジュールの8色モードの謎挙動 | シャポログ" />
  <meta property="og:description" content="AliExpress と Amazon で 480x320px の LCD モジュールを買ったのですが、ILI9488 の 8 色モードを試そうとしたところ謎の挙動に悩まされたので記録として残しておきます。" />
  <meta property="og:image" content="https://blog.shapoco.net/2025/0901-ili9488-8color-wired-behavior/thumbnail.jpg" />

  <link rel="icon" href="https://blog.shapoco.net/favicon192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="https://blog.shapoco.net/apple-touch-icon180.png" sizes="180x180">
  <link rel="shortcut icon" href="https://blog.shapoco.net/favicon48.ico">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KJ53WNQ22G"></script>
  <script>
    var remoteHost = window.location.hostname;
    if (remoteHost == "localhost") {
      console.log(`Google Analytics disabled on: '${remoteHost}'`);
    }
    else {
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'G-KJ53WNQ22G');
    }
  </script>

  <link href="/style.css?0ec49c72" rel="stylesheet" type="text/css">
  <script src="/style.js?0fd56873"></script>

  <link href="https://www.shapoco.net/navi/style.css?20241202163100" rel="stylesheet" type="text/css">
  <script src="https://www.shapoco.net/navi/navi.js?20241202163100"></script>

  <title>ILI9488 LCDモジュールの8色モードの謎挙動 | シャポログ</title>
</head>

<body>
  <div id="container">
    <div id="root_navi"></div>

    <header class="article_header">
      <h1><a href="/">シャポログ</a></h1>
    </header>
    <main>
      <h2>ILI9488 LCDモジュールの8色モードの謎挙動</h2>

      <div class="article_info_wrap">
        <div class="article_info">
          2025/09/01 |
          <a href="https://github.com/shapoco/blog/tree/main/src/article/2025/0901-ili9488-8color-wired-behavior/" target="_blank">記事のソース</a>
        </div>

        <div id="shpcstamp_wrap"></div>
        <script async src="/stamp/v1/widget.js?ce7d3635"></script>
      </div>

              <p>AliExpress と Amazon で 480x320px の LCD モジュールを買ったのですが、ILI9488 の 8 色モードを試そうとしたところ謎の挙動に悩まされたので記録として残しておきます。</p>
        <h3>ILI9488 の 8 色モード</h3>
        <p>ILI9488 の SPI インターフェイスには、表示色を 8 色に限定する代わりに 1 バイトに 2 ピクセルを詰めて転送できるモードがあり、RGB666 などと比べると大幅にデータ量を削減できます。</p>
        <p>SPI モードにて、Interface Pixel Format コマンドでパラメータの下位 3bit (DBI[2:0]) に 0x1 を設定することでこのモードを利用できます。</p>
        <p>データシートより:</p>
        <p><img src="./table.png" alt=""></p>
        <p><img src="./waveform.png" alt=""></p>
        <h3>謎挙動</h3>
        <p>AliExpress と Amazon で買ったタッチパネル付きモジュールでこのモードを試そうとしたのですが、以下のような問題が生じました。</p>
        <ol>
          <li>画面に黒いゴミが混じる</li>
          <li>同じ SPI バスに接続された他のデバイスにアクセスすると画面が消える or 崩れる</li>
        </ol>
        <p>色々試したところ、どうも以下のような挙動が原因のようです。</p>
        <ol>
          <li>画面書き換え後に別のコマンドを発行すると、なぜかそのコマンド自体が黒いピクセルとなって前回の書き換え領域の左上に書き込まれる</li>
          <li>一度画像を書き込むと、以降 CS ピンを High に戻しても Chip Select された状態が解除されない</li>
        </ol>
        <p>なお、これらの問題は 18bit モードや 24bit モードでは発生しませんでした。</p>
        <h3>黒いゴミ</h3>
        <p>黒いゴミが分かりやすいような簡単なデモを作りました。緑色の長方形を 10 個描画するプログラムです。</p>
        <p><video controls><source src="https://www.shapoco.net/media/2025/20250901_ili9488_wired_behavior_0.mp4" type="video/mp4" /></video></p>
        <p>詳細な処理内容は以下の通りです。</p>
        <ol>
          <li>画面全体を白で塗りつぶす (Column/Page Address Set + Memory Write)</li>
          <li>(X, Y) = (10, 10)</li>
          <li>以下を 10 回繰り返す</li>
          <li>1 秒待つ</li>
          <li>(X, Y) の位置から 32x32px の領域を選択 (Column/Page Address Set)</li>
          <li>1 秒待つ</li>
          <li>選択された 32x32px の領域を緑色で塗りつぶす (Memory Write)</li>
          <li>X += 40</li>
        </ol>
        <p>動画を観察すると、5 のタイミングで前回塗りつぶした領域の左上に黒い線が現れていることが分かります。5 のタイミングで他のコマンドを発行すると、黒い線はさらに伸びていきます。ゴミは <strong>前回の</strong> 描画領域に現れるため、一番最近更新した領域は期待通りの内容となります。これは単純なデモですが、より複雑な描画処理でも同様の挙動を示します。</p>
        <p>このことから、発行したコマンドそのものがなぜか黒いピクセルとなって前回の描画領域に現れているようです。部分書き換えを繰り返すとそのたびに前回の描画領域が汚されていくため、部分書き換えを繰り返すプログラムでは特に問題になります。</p>
        <p>常に画面全体を書き換える場合はゴミはすぐに正しい色で塗りつぶされるため実用上の問題はほとんど無くなりますが、画面を頻繁に書き換える場合は注意深く見ていると画面の左上に黒い線の断片がちらつくことがあります。</p>
        <p><video controls><source src="https://www.shapoco.net/media/2025/20250901_ili9488_wired_behavior_1.mp4" type="video/mp4" /></video></p>
        <p>もしかすると 8 色モードは常に画面全体を書き換えることを前提としているのかもしれません。</p>
        <h3>CS 制御が効かなくなる</h3>
        <p>こちらは同じ SPI バスを他のデバイスと共有する場合には致命的になります。</p>
        <p>デモを示します。左の ILI9488 ディスプレイを初期化して画像を表示し、その 3 秒後、同じバスに繋がっている右の ST7789 ディスプレイを初期化して画像を表示します (左のディスプレイが汚いですが、保護フィルムの汚れです)。</p>
        <p><video controls><source src="https://www.shapoco.net/media/2025/20250901_ili9488_wired_behavior_2.mp4" type="video/mp4" /></video></p>
        <p>ILI9488 ディスプレイは、最初に画像を表示した後は一切アクセスしていません。CS も電気的には High のままであることをオシロで確認しました。にも関わらず、ST7789 を初期化したタイミングで ILI9488 の画面が緑一色になってしまいました。処理の実行順によっては画像はすぐには消えず、徐々に淡くなっていくこともありました。</p>
        <p>色々試したところ、どうやら ILI9488 を 8 色モードにすると、Memory Write 以外のコマンドは正常に実行できるものの、Memory Write を一度でも実行すると CS を Low に固定したような状態になり、他のデバイスへ送ったデータをコマンドとして受け付けてしまうようです。</p>
        <p>これでは SPI バスを他のデバイスと共有することはできません。</p>
        <h3>ワークアラウンド？</h3>
        <p>黒いゴミについては、そもそも 8 色モードをやめるか、常に画面全体を書き換えるようにするのが近道になりそうです。どうしても 8 色モードで部分書き換えをしなければならない場合、ゴミの出現位置を予測し、一旦 18bit モードや 24bit モードに切り替えてゴミを正しい色で塗りつぶすという手が考えられますが、かなりトリッキーになりそうですし、8 色モードを使うメリットが無くなりそうです。</p>
        <p>CS 制御が効かなくなる問題については、ハードウェア的な対処ができない場合は 8 色モードで描画を完了した後に 18bit モードや 24bit モードに切り替えておくことで回避できそうです。8 色モードに設定されている間に他のデバイスへのアクセスが割り込むと台無しになるので、モードの切り替えと描画処理はアトミックに実行されるようにスケジュールする必要があります。</p>
        <h3>製品依存かもしれないし、使い方の問題かもしれない</h3>
        <p>今回、似た見た目のモジュールを AliExpress で 2 つ、Amazon で 1 つ購入しましたが、どれも同じ挙動でした。ただ、他の製品ではどうだか分かりません。データシートを隅々まで読んだわけではないので、私の使い方が間違っているだけかもしれません (LLM に PDF を投げて質問してみましたがよく分かりませんでした)。</p>
        <p>ILI9488 の 8 色モードを使用する場合はご注意ください。</p>

    </main>
    <footer>
      <span class="nowrap">
        Copyright &copy; <a href="https://x.com/shapoco/" target="_blank">Shapoco</a>,
      </span>
      <span class="nowrap">
        Powered by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
      </span>
    </footer>
  </div>
</body>

</html>